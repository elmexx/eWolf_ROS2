#!/bin/bash
CONTAINER_NAME="ros2-dev"
IMAGE_NAME="osrf/ros:humble-desktop-full"

# Check if container exists
if [ "$(docker ps -a -q -f name=^/${CONTAINER_NAME}$)" ]; then
    echo "Starting existing ROS 2 container..."
    docker start -ai ${CONTAINER_NAME}
else
    echo "Creating new ROS 2 container..."
    docker run -it \
        --name ${CONTAINER_NAME} \
        -e DISPLAY=$DISPLAY \
        -e QT_X11_NO_MITSHM=1 \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v ~/ros2_ws:/root/ros2_ws \
        ${IMAGE_NAME} \
        bash
fi


#!/bin/bash
CONTAINER_NAME="ros1-dev"
IMAGE_NAME="osrf/ros:noetic-desktop-full"

# Check if container exists
if [ "$(docker ps -a -q -f name=^/${CONTAINER_NAME}$)" ]; then
    echo "Starting existing ROS 1 container..."
    docker start -ai ${CONTAINER_NAME}
else
    echo "Creating new ROS 1 container..."
    docker run -it \
        --name ${CONTAINER_NAME} \
        -e DISPLAY=$DISPLAY \
        -e QT_X11_NO_MITSHM=1 \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v ~/ros_ws:/root/ros_ws \
        ${IMAGE_NAME} \
        bash
fi


chmod +x ~/docker_ros_env/run_ros1.sh
chmod +x ~/docker_ros_env/run_ros2.sh

echo "source /opt/ros/humble/setup.bash" >> ~/.bashrc
echo "source ~/ros2_ws/install/setup.bash" >> ~/.bashrc

echo "source /opt/ros/noetic/setup.bash" >> ~/.bashrc
echo "source ~/ros_ws/devel/setup.bash" >> ~/.bashrc


docker start -ai ros2-dev
docker commit ros2-dev ros2-dev-checkpoint:v1


å¾ˆå¥½ï¼ŒåŸºäºä½ ä¸»æœºçš„ç”¨æˆ·ä¿¡æ¯ï¼š

* ç”¨æˆ·åï¼š`fmon005`
* UIDï¼š`1000`
* GIDï¼š`1000`

æˆ‘ä¸ºä½ ç”Ÿæˆäº†ä¸€ä¸ª**é•¿æœŸå¼€å‘ç”¨çš„ ROS 2 Humble Docker é•œåƒ Dockerfile**ï¼Œå®ƒï¼š

* âœ… åŸºäº `osrf/ros:humble-desktop-full`
* âœ… åˆ›å»º `fmon005` ç”¨æˆ·ï¼ˆUID/GID ä¸å®¿ä¸»ä¸€è‡´ï¼‰
* âœ… é…ç½® GUI æ”¯æŒï¼ˆ`rviz`ã€`rqt`ï¼‰
* âœ… é»˜è®¤ä½¿ç”¨è¯¥ç”¨æˆ·è¿›å…¥å®¹å™¨ï¼Œé¿å… root æƒé™æ±¡æŸ“ä¸»æœºæ–‡ä»¶
* âœ… é€‚åˆé•¿æœŸå¼€å‘ï¼Œå¯ `apt install` è½¯ä»¶åæŒä¹…ä½¿ç”¨ï¼ˆå®¹å™¨ä¸åŠ  `--rm`ï¼‰

---

## âœ… æ­¥éª¤ä¸€ï¼šå‡†å¤‡ Dockerfileï¼ˆROS 2ï¼‰

ä¿å­˜ä¸ºï¼š`~/docker_ros_env/Dockerfile_ros2`

```dockerfile
FROM osrf/ros:humble-desktop-full

# æ·»åŠ é root ç”¨æˆ·ï¼Œä¸å®¿ä¸»ä¸€è‡´ï¼ˆç”¨æˆ·åã€UIDã€GIDï¼‰
ARG USERNAME=fmon005
ARG USER_UID=1000
ARG USER_GID=1000

RUN groupadd -g ${USER_GID} ${USERNAME} && \
    useradd -m -u ${USER_UID} -g ${USER_GID} -s /bin/bash ${USERNAME} && \
    echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

# è®¾ç½®é»˜è®¤ç”¨æˆ·å’Œå·¥ä½œç›®å½•
USER ${USERNAME}
WORKDIR /home/${USERNAME}

# ä¿è¯ source ROS ç¯å¢ƒ
RUN echo "source /opt/ros/humble/setup.bash" >> /home/${USERNAME}/.bashrc

# GUI æ”¯æŒå˜é‡
ENV QT_X11_NO_MITSHM=1
```

---

## âœ… æ­¥éª¤äºŒï¼šæ„å»ºè‡ªå®šä¹‰é•œåƒ

åœ¨ `~/docker_ros_env/` ä¸‹æ‰§è¡Œï¼š

```bash
docker build -f Dockerfile_ros2 -t ros2-dev-user .
```

---

## âœ… æ­¥éª¤ä¸‰ï¼šæ›´æ–° run è„šæœ¬ï¼ˆ`run_ros2.sh`ï¼‰

ä¿å­˜ä¸ºï¼š`~/docker_ros_env/run_ros2.sh`

```bash
#!/bin/bash

CONTAINER_NAME="ros2-dev"
IMAGE_NAME="ros2-dev-user"

docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"

if [ $? -eq 0 ]; then
    echo "Starting existing container '${CONTAINER_NAME}'..."
    docker start -ai ${CONTAINER_NAME}
else
    echo "Creating new container '${CONTAINER_NAME}'..."
    docker run -it \
        --name ${CONTAINER_NAME} \
        -e DISPLAY=$DISPLAY \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v ~/ros2_ws:/home/fmon005/ros2_ws \
        ${IMAGE_NAME} \
        bash
fi
```

---

## âœ… èµ‹äºˆæ‰§è¡Œæƒé™

```bash
chmod +x ~/docker_ros_env/run_ros2.sh
```

---

## âœ… ç°åœ¨ä½ å¯ä»¥è¿™æ ·å¼€å‘ï¼š

1. å¯åŠ¨å¼€å‘å®¹å™¨ï¼š

   ```bash
   ~/docker_ros_env/run_ros2.sh
   ```

2. åœ¨å®¹å™¨ä¸­ç»§ç»­å¼€å‘ï¼ˆå¦‚å¹³æ—¶ä¸€æ ·ï¼‰ï¼š

   ```bash
   cd ~/ros2_ws
   colcon build
   ros2 run ...
   ```

3. å®‰è£…åŒ…ï¼ˆå¦‚æœ‰éœ€è¦ï¼‰ï¼š

   ```bash
   sudo apt update
   sudo apt install ros-humble-navigation2
   ```

è¿™äº›å˜æ›´éƒ½ä¼šåœ¨å®¹å™¨ä¸­ä¿ç•™ã€‚

---

å¦‚æœä½ ä¹Ÿå¸Œæœ›æˆ‘ç”Ÿæˆ ROS 1 çš„ç‰ˆæœ¬ï¼ˆNoeticï¼‰â€” `Dockerfile_ros1` + `run_ros1.sh` â€” ä¹Ÿå¯ä»¥å‘Šè¯‰æˆ‘ï¼Œæˆ‘å¯ä»¥å¸®ä½ å¯¹ç§°é…ç½®ã€‚éœ€è¦å—ï¼Ÿ



å¥½çš„ï¼Œä»¥ä¸‹æ˜¯ä¸ä½ å½“å‰ä¸»æœºä¸€è‡´çš„ **ROS 1 Noetic Docker å¼€å‘ç¯å¢ƒé…ç½®**ï¼ŒåŒ…å«ï¼š

* âœ… Dockerfileï¼ˆåŸºäº `osrf/ros:noetic-desktop-full`ï¼‰
* âœ… åˆ›å»ºç”¨æˆ· `fmon005`ï¼ŒUID/GID = 1000
* âœ… æ”¯æŒ `rviz`ã€GUI
* âœ… è‡ªåŠ¨ `source` ROS ç¯å¢ƒ
* âœ… é…å¥— `run_ros1.sh` å¯åŠ¨è„šæœ¬ï¼Œæ”¯æŒé¦–æ¬¡åˆ›å»ºå’Œåç»­å¯åŠ¨
* âœ… å®¿ä¸»ç›®å½• `~/ros_ws` æŒ‚è½½åˆ°å®¹å™¨å†… `/home/fmon005/ros_ws`ï¼Œé€‚åˆé•¿æœŸå¼€å‘

---

## ğŸ“„ æ­¥éª¤ä¸€ï¼šä¿å­˜ Dockerfileï¼ˆROS 1ï¼‰

è·¯å¾„ï¼š`~/docker_ros_env/Dockerfile_ros1`

```dockerfile
FROM osrf/ros:noetic-desktop-full

ARG USERNAME=fmon005
ARG USER_UID=1000
ARG USER_GID=1000

# åˆ›å»ºç”¨æˆ·å¹¶é…ç½® sudo æƒé™
RUN groupadd -g ${USER_GID} ${USERNAME} && \
    useradd -m -u ${USER_UID} -g ${USER_GID} -s /bin/bash ${USERNAME} && \
    echo "${USERNAME} ALL=(ALL) NOPASSWD:ALL" >> /etc/sudoers

USER ${USERNAME}
WORKDIR /home/${USERNAME}

# é»˜è®¤åŠ è½½ ROS ç¯å¢ƒ
RUN echo "source /opt/ros/noetic/setup.bash" >> /home/${USERNAME}/.bashrc

ENV QT_X11_NO_MITSHM=1
```

---

## ğŸ›  æ­¥éª¤äºŒï¼šæ„å»ºé•œåƒ

åœ¨ `~/docker_ros_env` ä¸­è¿è¡Œï¼š

```bash
docker build -f Dockerfile_ros1 -t ros1-dev-user .
```

---

## ğŸš€ æ­¥éª¤ä¸‰ï¼šä¿å­˜å¯åŠ¨è„šæœ¬ `run_ros1.sh`

è·¯å¾„ï¼š`~/docker_ros_env/run_ros1.sh`

```bash
#!/bin/bash

CONTAINER_NAME="ros1-dev"
IMAGE_NAME="ros1-dev-user"

docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"

if [ $? -eq 0 ]; then
    echo "Starting existing container '${CONTAINER_NAME}'..."
    docker start -ai ${CONTAINER_NAME}
else
    echo "Creating new container '${CONTAINER_NAME}'..."
    docker run -it \
        --name ${CONTAINER_NAME} \
        -e DISPLAY=$DISPLAY \
        -v /tmp/.X11-unix:/tmp/.X11-unix \
        -v ~/ros_ws:/home/fmon005/ros_ws \
        ${IMAGE_NAME} \
        bash
fi
```

---

## âœ… æ­¥éª¤å››ï¼šèµ‹äºˆæ‰§è¡Œæƒé™

```bash
chmod +x ~/docker_ros_env/run_ros1.sh
```

---

## ğŸ§ª ä½¿ç”¨æ–¹å¼

* å¯åŠ¨ ROS 1 å¼€å‘å®¹å™¨ï¼š

  ```bash
  ~/docker_ros_env/run_ros1.sh
  ```

* åœ¨å®¹å™¨ä¸­è¿›è¡Œ ROS 1 å¼€å‘ï¼š

  ```bash
  cd ~/ros_ws
  catkin_make
  rosrun ...
  ```

* å®‰è£…æ–°åŒ…ï¼ˆé•¿æœŸæœ‰æ•ˆï¼‰ï¼š

  ```bash
  sudo apt install ros-noetic-navigation
  ```

---

## âœ… æœ€ç»ˆç»“æœ

ä½ ç°åœ¨æ‹¥æœ‰ä¸¤ä¸ªç‹¬ç«‹ã€æŒä¹…ã€å®‰å…¨çš„å¼€å‘ç¯å¢ƒï¼š

| å¼€å‘ç¯å¢ƒ  | å¯åŠ¨è„šæœ¬          | é•œåƒå             | ç”¨æˆ·        | æŒ‚è½½è·¯å¾„                                  |
| ----- | ------------- | --------------- | --------- | ------------------------------------- |
| ROS 1 | `run_ros1.sh` | `ros1-dev-user` | `fmon005` | `~/ros_ws` â†’ `/home/fmon005/ros_ws`   |
| ROS 2 | `run_ros2.sh` | `ros2-dev-user` | `fmon005` | `~/ros2_ws` â†’ `/home/fmon005/ros2_ws` |

å¦‚æœä½ ä»¥åè¿˜æƒ³æ·»åŠ ï¼š

* å¤šå®¹å™¨é€šä¿¡ï¼ˆbridge/network hostï¼‰
* ROS + VSCode devcontainer
* æ•°æ®é›†æˆ–è®¾å¤‡æŒ‚è½½ï¼ˆå¦‚ bag æ–‡ä»¶ã€USB ç›¸æœºï¼‰

ä¹Ÿå¯ä»¥å‘Šè¯‰æˆ‘ï¼Œæˆ‘å¯ä»¥ç»§ç»­å¸®ä½ æ‰©å±•è¿™å¥—ä½“ç³»ã€‚


#!/bin/bash

CONTAINER_NAME="ros1-dev"
IMAGE_NAME="ros1-dev-user"

# æ£€æŸ¥å®¹å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œ
if docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
    echo "Container '${CONTAINER_NAME}' is already running."
    echo "Opening a new terminal in the running container..."
    docker exec -it ${CONTAINER_NAME} bash
    exit 0
fi

# å¦‚æœå®¹å™¨å­˜åœ¨ä½†æœªè¿è¡Œï¼Œåˆ™å¯åŠ¨å¹¶ attach
if docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
    echo "Starting existing container '${CONTAINER_NAME}'..."
    docker start -ai ${CONTAINER_NAME}
    exit 0
fi

# å¦åˆ™æ–°å»ºå®¹å™¨
echo "Creating and starting new container '${CONTAINER_NAME}'..."
docker run -it \
    --name ${CONTAINER_NAME} \
    -e DISPLAY=$DISPLAY \
    -e QT_X11_NO_MITSHM=1 \
    -v /tmp/.X11-unix:/tmp/.X11-unix \
    -v ~/ros_ws:/home/fmon005/ros_ws \
    ${IMAGE_NAME} \
    bash

#!/bin/bash

CONTAINER_NAME="ros2-dev"
IMAGE_NAME="ros2-dev-user"

# æ£€æŸ¥å®¹å™¨æ˜¯å¦æ­£åœ¨è¿è¡Œ
if docker ps --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
    echo "Container '${CONTAINER_NAME}' is already running."
    echo "Opening a new terminal in the running container..."
    docker exec -it ${CONTAINER_NAME} bash
    exit 0
fi

# å¦‚æœå®¹å™¨å­˜åœ¨ä½†æœªè¿è¡Œï¼Œåˆ™å¯åŠ¨å¹¶ attach
if docker ps -a --format '{{.Names}}' | grep -q "^${CONTAINER_NAME}$"; then
    echo "Starting existing container '${CONTAINER_NAME}'..."
    docker start -ai ${CONTAINER_NAME}
    exit 0
fi

# å¦åˆ™æ–°å»ºå®¹å™¨
echo "Creating and starting new container '${CONTAINER_NAME}'..."
docker run -it \
    --name ${CONTAINER_NAME} \
    -e DISPLAY=$DISPLAY \
    -e QT_X11_NO_MITSHM=1 \
    -v /tmp/.X11-unix:/tmp/.X11-unix \
    -v ~/ros2_ws:/home/fmon005/ros2_ws \
    ${IMAGE_NAME} \
    bash

import rclpy
from rclpy.node import Node
from sensor_msgs.msg import Image, PointCloud2
from cv_bridge import CvBridge
import cv2
import sensor_msgs_py.point_cloud2 as pc2
import numpy as np
import open3d as o3d
from pynput import keyboard
import os

class ImagePointcloudSaver(Node):
    def __init__(self):
        super().__init__('image_pcd_saver')

        # å‚æ•°
        self.declare_parameter('image_topic', '/camera/color/image_raw')
        self.declare_parameter('pointcloud_topic', '/scala_decoder_sdk_point_2')

        image_topic = self.get_parameter('image_topic').get_parameter_value().string_value
        pc_topic = self.get_parameter('pointcloud_topic').get_parameter_value().string_value

        self.get_logger().info(f"Subscribed to: {image_topic} & {pc_topic}")

        # æ•°æ®ç¼“å­˜
        self.bridge = CvBridge()
        self.latest_image = None
        self.latest_pc = None
        self.count = 0

        # è®¢é˜…
        self.create_subscription(Image, image_topic, self.image_callback, 10)
        self.create_subscription(PointCloud2, pc_topic, self.pc_callback, 10)

        # å¯åŠ¨é”®ç›˜ç›‘å¬çº¿ç¨‹
        listener = keyboard.Listener(on_press=self.on_key_press)
        listener.start()

    def image_callback(self, msg):
        self.latest_image = msg

    def pc_callback(self, msg):
        self.latest_pc = msg

    def on_key_press(self, key):
        if key == keyboard.Key.space:
            if self.latest_image and self.latest_pc:
                self.save_data()
            else:
                self.get_logger().warn("æ•°æ®å°šæœªå‡†å¤‡å¥½")

    def save_data(self):
        # å›¾åƒä¿å­˜
        cv_image = self.bridge.imgmsg_to_cv2(self.latest_image, desired_encoding='bgr8')
        image_filename = f'image_{self.count:04d}.jpg'
        cv2.imwrite(image_filename, cv_image)

        # ç‚¹äº‘ä¿å­˜
        points = np.array([
            [p[0], p[1], p[2]]
            for p in pc2.read_points(self.latest_pc, field_names=("x", "y", "z"), skip_nans=True)
        ], dtype=np.float32)

        pcd = o3d.geometry.PointCloud()
        pcd.points = o3d.utility.Vector3dVector(points)
        pcd_filename = f'cloud_{self.count:04d}.pcd'
        o3d.io.write_point_cloud(pcd_filename, pcd)

        self.get_logger().info(f"Saved image as {image_filename} and pointcloud as {pcd_filename}")
        self.count += 1

def main(args=None):
    rclpy.init(args=args)
    node = ImagePointcloudSaver()
    try:
        rclpy.spin(node)
    except KeyboardInterrupt:
        pass
    node.destroy_node()
    rclpy.shutdown()

if __name__ == '__main__':
    main()
